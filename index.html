<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隨機術語測驗</title>
    <!-- 引入 Tailwind CSS 以進行快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除行動裝置點擊時的藍色背景 */
        }
        /* 選項按鈕的基本樣式 */
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        /* 正確答案的樣式 */
        .correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a !important; /* green-600 */
            transform: scale(1.05);
        }
        /* 錯誤答案的樣式 */
        .incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626 !important; /* red-600 */
        }
        /* 禁用按鈕的樣式 */
        .disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        /* 讓圖片容器有固定的長寬比，避免頁面跳動 */
        #answer-image-container {
            aspect-ratio: 16 / 9;
        }
    </style>
</head>
<body class="g-white flex justify-center pt-12 px-4 min-h-screen">

    <div id="quiz-container" class="w-full max-w-2xl mx-auto p-6 md:p-8">
        
        <!-- 測驗開始畫面 -->
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-4">航空術語隨機測驗</h1>
            <p class="text-slate-600 mb-8">準備好挑戰10個隨機問題了嗎？</p>
            <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                開始測驗
            </button>
        </div>

        <!-- 測驗進行中畫面 -->
        <div id="quiz-screen" class="hidden">
            <!-- 頂部資訊列 -->
            <div class="flex justify-between items-center mb-6">
                <div id="progress" class="text-lg font-semibold text-slate-500">問題 1 / 10</div>
                <div id="score" class="text-lg font-bold text-blue-600">分數: 0</div>
            </div>

            <!-- 問題區 -->
            <div class="mb-6">
                <p class="text-slate-500 text-sm font-medium mb-2">請根據以下中文定義，選擇正確的英文術語：</p>
                <div id="question" class="text-2xl md:text-3xl font-bold text-slate-800 bg-slate-50 p-4 rounded-lg min-h-[100px] flex items-center"></div>
            </div>

            <!-- 選項區 -->
            <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <!-- 選項按鈕會由 JavaScript 動態生成 -->
            </div>

            <!-- 答案回饋區 -->
            <div id="feedback-container" class="text-center hidden">
                 <div id="answer-image-container" class="w-full max-w-md mx-auto mb-4 bg-slate-200 rounded-lg overflow-hidden flex items-center justify-center">
                    <img id="answer-image" src="" alt="正確答案示意圖" class="hidden w-full h-full object-contain">
                    <p id="image-placeholder" class="text-slate-500">此處將顯示正確答案圖片</p>
                </div>
                <p id="feedback-text" class="text-xl font-bold mb-4"></p>
                <button id="next-btn" class="w-full sm:w-auto bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105">
                    下一題
                </button>
            </div>
        </div>

        <!-- 測驗結束畫面 -->
        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-4">測驗結束！</h2>
            <p class="text-2xl text-slate-600 mb-2">你的最終成績是：</p>
            <p id="final-score" class="text-6xl font-bold text-blue-600 mb-8">0 / 10</p>
            <button id="restart-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                再玩一次
            </button>
        </div>

    </div>

    <script>
        // --- DOM 元素 ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');

        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');

        const progressText = document.getElementById('progress');
        const scoreText = document.getElementById('score');
        const questionText = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackText = document.getElementById('feedback-text');
        const answerImageContainer = document.getElementById('answer-image-container');
        const answerImage = document.getElementById('answer-image');
        const imagePlaceholder = document.getElementById('image-placeholder');

        const finalScoreText = document.getElementById('final-score');

        // --- 測驗狀態變數 ---
        let allQuestions = []; // 從 JSON 載入的所有問題
        let quizQuestions = []; // 本次測驗的10個問題
        let currentQuestionIndex = 0;
        let score = 0;
        const TOTAL_QUESTIONS = 10;
        const IMAGE_PATH = './answers/'; // 答案圖片所在的資料夾路徑

        // --- 事件監聽 ---
        startBtn.addEventListener('click', startQuiz);
        nextBtn.addEventListener('click', nextQuestion);
        restartBtn.addEventListener('click', startQuiz);

        // --- 函式 ---

        /**
         * 載入題庫 JSON 檔案
         */
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error('無法載入題庫檔案 (questions.json)。請確認檔案存在且路徑正確。');
                }
                allQuestions = await response.json();
                console.log('題庫載入成功:', allQuestions.length, '題');
            } catch (error) {
                console.error(error);
                questionText.textContent = error.message;
            }
        }

        /**
         * 開始測驗
         */
        function startQuiz() {
            // 重設狀態
            score = 0;
            currentQuestionIndex = 0;
            
            // 從所有問題中隨機選出10題
            quizQuestions = shuffleArray([...allQuestions]).slice(0, TOTAL_QUESTIONS);

            if (quizQuestions.length < TOTAL_QUESTIONS) {
                alert(`錯誤：題庫數量不足 ${TOTAL_QUESTIONS} 題，無法開始測驗。`);
                return;
            }

            // 切換畫面
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            displayQuestion();
        }

        /**
         * 顯示目前問題及選項
         */
        function displayQuestion() {
            // 重設上一題的回饋
            feedbackContainer.classList.add('hidden');
            optionsContainer.classList.remove('disabled');
            optionsContainer.innerHTML = ''; // 清空舊選項

            // 取得目前問題
            const currentQuestion = quizQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.term;

            // 更新進度與分數
            progressText.textContent = `問題 ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS}`;
            scoreText.textContent = `分數: ${score}`;
            questionText.textContent = currentQuestion.definition;

            // 產生選項
            const options = generateOptions(correctAnswer);
            
            // 建立選項按鈕並顯示
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'p-4', 'border-2', 'border-slate-300', 'rounded-lg', 'text-left', 'text-lg', 'font-semibold', 'text-slate-700', 'hover:bg-slate-100', 'hover:border-blue-500');
                button.addEventListener('click', () => selectAnswer(option, correctAnswer, button));
                optionsContainer.appendChild(button);
            });
        }

        /**
         * 產生包含一個正確答案和三個錯誤答案的選項陣列
         * @param {string} correctAnswer - 正確的術語
         * @returns {string[]} - 隨機排序後的四個選項
         */
        function generateOptions(correctAnswer) {
            let options = [correctAnswer];
            let wrongAnswers = allQuestions
                .map(q => q.term)
                .filter(term => term !== correctAnswer); // 過濾掉正確答案

            // 隨機選取三個不重複的錯誤答案
            wrongAnswers = shuffleArray(wrongAnswers);
            for (let i = 0; i < 3; i++) {
                if(wrongAnswers[i]) {
                    options.push(wrongAnswers[i]);
                }
            }
            
            return shuffleArray(options);
        }

        /**
         * 當使用者選擇答案時觸發
         * @param {string} selectedAnswer - 使用者選擇的答案
         * @param {string} correctAnswer - 正確答案
         * @param {HTMLElement} selectedButton - 使用者點擊的按鈕
         */
        function selectAnswer(selectedAnswer, correctAnswer, selectedButton) {
            // 禁用所有選項按鈕，防止重複點擊
            optionsContainer.classList.add('disabled');
            
            // 檢查答案是否正確
            const isCorrect = selectedAnswer === correctAnswer;

            if (isCorrect) {
                score++;
                feedbackText.textContent = '答對了！';
                feedbackText.className = 'text-xl font-bold mb-4 text-green-600';
                selectedButton.classList.add('correct');
            } else {
                feedbackText.textContent = `答錯了！正確答案是 ${correctAnswer}`;
                feedbackText.className = 'text-xl font-bold mb-4 text-red-600';
                selectedButton.classList.add('incorrect');
                // 找出並標示正確答案的按鈕
                Array.from(optionsContainer.children).forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }

            // 更新分數顯示
            scoreText.textContent = `分數: ${score}`;
            
            // 顯示回饋區和答案圖片
            displayAnswerImage(correctAnswer);
            feedbackContainer.classList.remove('hidden');

            // 如果是最後一題，將按鈕文字改為 "查看結果"
            if (currentQuestionIndex === TOTAL_QUESTIONS - 1) {
                nextBtn.textContent = '查看結果';
            }
        }

        /**
         * 顯示正確答案的圖片
         * @param {string} term - 正確答案的術語
         */
        function displayAnswerImage(term) {
            // 將術語中的空格替換為底線，以符合圖片檔名慣例
            const imageName = term.replace(/\s+/g, '_') + '.jpg';
            const imageUrl = IMAGE_PATH + imageName;
            
            answerImage.src = imageUrl;
            answerImage.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');

            // 圖片載入成功時顯示圖片，隱藏佔位文字
            answerImage.onload = () => {
                imagePlaceholder.classList.add('hidden');
                answerImage.classList.remove('hidden');
            };
            // 圖片載入失敗時，在 console 中顯示錯誤，並保持佔位文字
            answerImage.onerror = () => {
                console.error(`無法載入圖片: ${imageUrl}`);
                imagePlaceholder.textContent = `找不到圖片: ${imageName}`;
                imagePlaceholder.classList.remove('hidden');
                answerImage.classList.add('hidden');
            };
        }

        /**
         * 前往下一題
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < TOTAL_QUESTIONS) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        /**
         * 顯示最終結果
         */
        function showResults() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            finalScoreText.textContent = `${score} / ${TOTAL_QUESTIONS}`;
            nextBtn.textContent = '下一題'; // 重設按鈕文字以備下次測驗
        }

        /**
         * Fisher-Yates (aka Knuth) Shuffle 演算法
         * @param {Array} array - 要被隨機排序的陣列
         * @returns {Array} - 排序後的陣列
         */
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- 初始化 ---
        // 頁面載入後，首先載入題庫
        loadQuestions();

    </script>
</body>
</html>
